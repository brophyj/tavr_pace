---
title: "Pacemaker Risk Following TAVR"
author: "Arthur M. Albuquerque and James Brophy MD PhD "
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output: word_document
bibliography: references.bib
link-citations: yes
linkcolor: red
urlcolor: blue
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message=FALSE, error=FALSE, warning=FALSE, comment=NA, echo = knitr::is_html_output())   
options(mc.cores = parallel::detectCores())   

# for pdf page breaks - insert`r pagebreak()`
pagebreak <- function() {
  if(knitr::is_latex_output())
    return("\\newpage")
  else
    return('<div style="page-break-before: always;" />')
}

```

```{r packages}
library("rprojroot")
library("rstanarm")
library("arm")
library("bayesplot")
library("rms")
library("survival")
library("survminer")
library("here")
library("IPDfromKM")
library("tidyverse")
library("KMunicate")
library("patchwork")
               
theme_set(bayesplot::theme_default(base_family = "sans"))
savefigs <- TRUE

```

## Introduction

Recently, a nationwide Swedish, population-based cohort study found no
statistically significant difference for all-cause mortality (hazard ratio [HR] 1.03; 95% CI: 0.88 - 1.22; P = 0.692) in patients who underwent permanent pacemaker implantation after transcatheter aortic valve replacement (TAVR) between 2008 and
2018 [@RN5759]. Leading the authors to conclude that long-term survival
between patients who did and did not undergo permanent pacemaker
implantation after TAVR was not different. While the study included a
large unselected sample of 3,420 TAVR patients, there are a number of
reasons why it is of interest to query the strength of the evidence
supporting their conclusion. 

First, their central Kaplan-Meier curve shows survival curves crossing,
raising the possibility of a time-varying HR such that the proportional
hazards assumptions underlying their analysis may not be valid. Second
given this is an elderly population (mean age \> 81), the performed
comparative lifetime analysis with some patients followed up to 10
years may not be the most informative and clinically relevant. As
eventually, we all die and this analysis perhaps obscures some earlier
clinically pertinent mortality differences among those receiving and not
receiving pacemakers post-TAVR. Thirdly, the same nationwide databases
have examined the mortality impact of pacemaker implantation in a
contemporary population of aortic stenosis patients undergoing surgical
aortic valve replacement (SAVR) [@RN5758] and the inclusion of all or
some of this additional evidence may be informative. 

A Bayesian analysis [@RN4985] directly estimates the probability of
increased mortality post pacemaker insertion and which allows the
incorporation of past knowledge may be helpful in furthering our
understanding of this data by presenting actionable probabilities.

## Methods

### Data source

To gain approximate access to this dataset, we digitalized the reported
Kaplan-Meier mortality curve in the propensity score-matched cohort [@RN5759] using
the R package IPDfromKM [@IPDfromKM] thereby allowing secondary Bayesian
survival analyses to be performed. Further details about the extraction process can be found in our analysis protocol (REFERENCE TO OSF PROJECT).

### Outcome

This analysis is limited to the main outcome of total mortality as that is
the only outcome for which we can estimate Kaplan-Meier-derived
individual patient data (IPD). Given that the median follow-up is 2.7
years, that the KM slopes appear to change beyond 4 years and that
assessing the impact of pacemaker implantation seems clinically most
relevant in this shorter time window, we prespecified a maximum 4 year
follow-up.

### Statistical analyses

Bayesian approaches to survival analysis can provide a number of
benefits over the classical frequentist approach, including the ability
to make direct probability statements about parameters of interest (the
risk of pacemaker implantation), and to incorporate prior knowledge. 

The mechanics of the Bayesian analyses were performed using the Stan programming
language [@stan] through the R package 
rstanarm [@rstanarm]. We fitted a proportional hazard regression model using cubic M-splines for the baseline hazard. Further details about the model can be found in our analysis protocol (REFERENCE TO OSF PROJECT).
All analyses were conducted in R (R Environment version 4.0.4), and the statistical code can be found on [Github](https://github.com/brophyj/tavr_pace). 

## Results

### Bayesian survival analysis

```{r load bayesian models}

# Posteriors
load(here::here("output/fit/bayesian_model_vague.RData"))
load(here::here("output/fit/bayesian_model_informative.RData"))

```

```{r vague interval + probability}
vague_interval = 
  vague %>% 
  tidybayes::tidy_draws() %>% 
  ggdist::mean_qi(treatPacemaker) %>% 
  dplyr::select(1:3) %>% 
  exp() %>% 
  round(2)

vague_prob = 
  vague %>% 
  tidybayes::tidy_draws() %>% 
  summarise(prob = 100*round(mean(treatPacemaker > log(1)),2))


```

```{r informative interval + probability}
# Prior info
prior_informative = rstanarm::prior_summary(informative)


prior_mean = round(exp(prior_informative$priorEvent$location), 2)
prior_ci = 
  stringr::str_c(
    round(exp(prior_informative$priorEvent$location - 
      prior_informative$priorEvent$scale * 1.96),2),
    " - ",
    round(exp(prior_informative$priorEvent$location + 
      prior_informative$priorEvent$scale * 1.96), 2)
  )


informative_interval = 
  informative %>% 
  tidybayes::tidy_draws() %>% 
  ggdist::mean_qi(treatPacemaker) %>% 
  dplyr::select(1:3) %>% 
  exp() %>% 
  round(2)

informative_prob = 
  informative %>% 
  tidybayes::tidy_draws() %>% 
  summarise(prob = 100*round(mean(treatPacemaker > log(1)),2))

```

Using a vague prior the HR is `r vague_interval[[1]]` (95% credible interval [CrI] `r vague_interval[[2]]` - `r vague_interval[[3]]`). While the CrI
approximates the previously calculated CI, it can now be used to formulate
direct probability statements. As shown in Figure 1, the use of a
pacemaker is compatible with an `r vague_prob[[1]]`% probability of increased mortality
compared to those not receiving a pacemaker.

Previously research using the same Swedish databases have examined the
risk of a pacemaker in patients undergoing SAVR [@RN5759] and found an
increased risk (HR 1.14; 95% CI, 1.01 - 1.29). Given the
similarities in the populations, everyone with aortic stenosis
undergoing treatment in the same hospitals in the same treatment
windows, it seems reasonable to use this information, down weighted as described in the Methods,  to represent our
prior beliefs. With this informative prior, the HR for the no pacemaker
group is `r prior_mean`, 95% credible interval (CrI `r prior_ci`). Using this informative prior, it can
be appreciated that the probability of increased mortality following a
pacemaker post TAVR is `r informative_prob[[1]]`%.\

## Discussion

In this reanalysis of a recent publication from the SWEDEHEART
registry [@RN5759], we were able to reliably extract the individual
patient data concerning TAVR mortality as a function of receiving or not
a permanent cardiac pacemaker. We analyzed
the risk associated with a cardiac pacemaker using a 4-year
window. This has the advantages of being a period when the hazard ratios
appear constant as well as providing results in a more clinically
pertinent risk window. 

The Bayesian analysis with a vague prior revealed an `r vague_prob[[1]]`%
probability of increased mortality among TAVR patients requiring a
pacemaker group compared those not requiring the same. The probability of
increased mortality is augmented to `r informative_prob[[1]]`% when informative prior knowledge about the risk of mortality with pacemakers in
aortic stenosis patients undergoing SAVR is integrated into the decision
calculus.

By concentrating on parameter estimation rather than on
null hypothesis statistical testing and by incorporating relevant
background knowledge, this Bayesian analysis arguably leads to a more
insightful assessment of the risks of pacemakers following TAVR. Using
aggregate data from previous clinical trials, multiple publications have
demonstrated the additional advantages of Bayesian re-analyses [@goligher][@brophy]. The
current article suggests that similar benefits may be observed when
this approach is applied to individual patient data in the context of an 
observational research design.

While the original publication concluded there was "no difference in long-term survival between
patients who did and did not undergo permanent pacemaker implantation
after TAVR", this Bayesian reanalysis suggests a moderate to high probability that pacemaker implantation is associated with increased mortality in the first 4 years following TAVR.

```{r fig1, fig.width=7, fig.height=8, fig.align='center'}
# Prior info
prior_vague = rstanarm::prior_summary(vague)
SWEDEHEART_mean = log(1.03)
SWEDEHEART_se = (log(1.22) - log(0.88))/3.92
  
p1 = 
  vague %>%
  tidybayes::tidy_draws() %>%
  ggplot(aes(x = treatPacemaker,
             fill_ramp = stat(x > log(1)))
         ) +
  # Only posterior with  ggdist::stat_halfeye()
  ggdist::stat_halfeye(fill = "skyblue", # distribution fill
                       # very important so all distributions are comparable
                       normalize = "none", 
                       .width = 0.95, # 95% CrI
                       point_interval = ggdist::mean_qi
                       ) +
  # To fill posterior distribution OR > 1 as gray
  ggdist::scale_fill_ramp_discrete(from = "gray85", range = c(0,1)) +
  
  # Prior 
  stat_function(fun = dnorm,
                args = c(mean = prior_vague$priorEvent$location,
                         sd = prior_vague$priorEvent$scale),
                alpha = 0.8) +
  # Original data 
  stat_function(fun = dnorm,
                args = c(mean = SWEDEHEART_mean,
                         sd = SWEDEHEART_se),
                alpha = 0.5,
                color = "firebrick") +
  
  # Prior
  annotate(geom = "curve",
           x = log(0.7), y = 1.4,
           xend = log(0.75), yend = 0.25, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(0.7), y = 1.7, label = "Vague Prior", hjust = "center") +
  
  
  # Original data
  annotate(geom = "curve",
           x = log(0.8), y = 3.8,
           xend = log(0.93), yend = 3, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(0.8), y = 4.1, label = "SWEDEHEART TAVR", hjust = "center") +
  
  # Posterior
  annotate(geom = "curve",
           x = log(1.28), y = 3.05,
           xend = log(1.2), yend = 2.3, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(1.5), y = 3.1, label = "Posterior Distribution", hjust = "center") +
  
  # Vertical dashed line
  geom_vline(xintercept = log(1), linetype = 2) +
  
  scale_y_continuous(limits = c(0, 6),
                     breaks = seq(0, 6, 2),
                     expand = c(0, 0.1)) +
  scale_x_continuous(breaks = log(seq(0.7, 1.6, 0.1)),
                     limits = log(c(0.65, 1.75)),
                     labels = seq(0.7, 1.6, 0.1)) +
  labs(x = "Hazard Ratio (log scale)",
       y = "Density") +
  ggdist::theme_ggdist() +
  theme(legend.position = 'none',
        plot.title.position = 'plot',
        plot.margin = margin(20, 20, 20, 20))

p2 = 
  informative %>%
  tidybayes::tidy_draws() %>%
  ggplot(aes(x = treatPacemaker,
             fill_ramp = stat(x > log(1)))
         ) +
  # Only posterior with  ggdist::stat_halfeye()
  ggdist::stat_halfeye(fill = "skyblue", # distribution fill
                       # very important so all distributions are comparable
                       normalize = "none", 
                       .width = 0.95, # 95% CrI
                       point_interval = ggdist::mean_qi
                       ) +
  # To fill posterior distribution OR > 1 as gray
  ggdist::scale_fill_ramp_discrete(from = "gray85", range = c(0,1)) +
  
  # Prior 
  stat_function(fun = dnorm,
                args = c(mean = prior_informative$priorEvent$location,
                         sd = prior_informative$priorEvent$scale),
                alpha = 0.5) +
  # Original data 
  stat_function(fun = dnorm,
                args = c(mean = SWEDEHEART_mean,
                         sd = SWEDEHEART_se),
                alpha = 0.5,
                color = "firebrick") +
  
  # Prior
  annotate(geom = "curve",
           x = log(1.45), y = 1.76,
           xend = log(1.35), yend = 1.1, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(1.65), y = 1.8, label = "Informative Prior", hjust = "center") +
  
  
  # Original data
  annotate(geom = "curve",
           x = log(0.8), y = 3.8,
           xend = log(0.93), yend = 3, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(0.8), y = 4.1, label = "SWEDEHEART TAVR", hjust = "center") +
  
  # Posterior
  annotate(geom = "curve",
           x = log(1.31), y = 5.1,
           xend = log(1.17), yend = 4.5, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(1.53), y = 5.1, label = "Posterior Distribution", hjust = "center") +
  
  # Vertical dashed line
  geom_vline(xintercept = log(1), linetype = 2) +
  
  scale_y_continuous(limits = c(0, 6),
                     breaks = seq(0, 6, 2),
                     expand = c(0, 0.1)) +
  scale_x_continuous(breaks = log(seq(0.7, 1.6, 0.1)),
                     limits = log(c(0.65, 1.75)),
                     labels = seq(0.7, 1.6, 0.1)) +
  labs(x = "Hazard Ratio (log scale)",
       y = "Density") +
  ggdist::theme_ggdist() +
  theme(legend.position = 'none',
        plot.title.position = 'plot',
        plot.margin = margin(20, 20, 20, 20))

p1 / p2 + plot_annotation(tag_levels = "A")
```

## References