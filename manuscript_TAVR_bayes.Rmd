---
title: "Pacemaker Risk Following TAVR"
author: "James Brophy MD PhD and Arthur M. Albuquerque"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
   # toc: yes
  html_document:
    code_folding: hide
    highlight: tango
    theme: cerulean
  word_document:
    toc: yes
bibliography: references.bib
link-citations: yes
linkcolor: red
urlcolor: blue
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message=FALSE, error=FALSE, warning=FALSE, comment=NA, echo = knitr::is_html_output())   
options(mc.cores = parallel::detectCores())   

# for pdf page breaks - insert`r pagebreak()`
pagebreak <- function() {
  if(knitr::is_latex_output())
    return("\\newpage")
  else
    return('<div style="page-break-before: always;" />')
}

```

```{r packages}
library("rprojroot")
library("rstanarm")
library("arm")
library("bayesplot")
library("rms")
library("survival")
library("survminer")
library("here")
library("IPDfromKM")
library("tidyverse")
library("KMunicate")
library("patchwork")
               
theme_set(bayesplot::theme_default(base_family = "sans"))
savefigs <- TRUE

```

## Introduction

Recently, a nationwide Swedish, population-based cohort study found no
statistically significant difference for the risk of cardiovascular
death (hazard ratio (HR): 0.91; 95% CI: 0.71 - 1.18; P = 0.611) in
patients who underwent permanent pacemaker implantation after
transcatheter aortic valve replacement (TAVR) between 2008 and
2018 [@RN5759]. Leading the authors to conclude that long-term survival
between patients who did and did not undergo permanent pacemaker
implantation after TAVR was not different. While the study included a
large unselected sample of 3,420 TAVR patients, there are a number of
reasons why it is of interest to query the strength of the evidence
supporting their conclusion. <br>

First, their central Kaplan Meier curve shows survival curves crossing,
raising the possibility of a time varying HR such that the proportional
hazards assumptions underlying their analysis may not be valid. Second
given this is an elderly population (mean age \> 81), the performed
comparative life time analysis with some patients followed up to 10
years may not be the most informative and clinically relevant. As
eventually we all die and this analysis perhaps obscures some earlier
clinically pertinent mortality differences among those receiving and not
receiving pacemakers post TAVR. Thirdly, the same nationwide databases
have examined the mortality impact of pacemaker implantation in a
contemporary population of aortic stenosis patients undergoing surgical
aortic valve replacement (SAVR) [@RN5758] and the inclusion of all or
some of this additional evidence may be informative. <br>

A Bayesian analysis [@RN4985] which directly estimates the probability of
increased mortality post pacemaker insertion and which allows the
incorporation of past knowledge may be helpful in furthering our
understanding of this data by presenting actionable probabilities.\
<br>

## Methods

<br>

### Data source

<br>

To gain approximate access to this dataset, we digitalized the reported
Kaplan-Meier mortality curve [@RN5759]. This was operationalized by
following the technique of Guyot [@RN5762], utilizing
[WebPlotDigitalizer](https://apps.automeris.io/wpd/) and the R
programming language [@R]. Specifically, this reconstruction of the
individual patient data used the R package IPDfromKM [@IPDfromKM] thereby
allowing secondary Bayesian survival analyses to be performed. <br>

### Outcome

<br>

While the original publication examined several different outcomes, this
analysis is limited to the main outcome of total mortality as that is
the only outcome for which we can estimate Kaplan--Meier-derived
individual patient data (IPD). Given that the median follow-up is 2.7
years, that the KM slopes appear to change beyond 4 years and that
assessing the impact of pacemaker implantation seems clinically most
relevant in this shorter time window, we prespecified a maximum 4 year
follow-up

### Statistical analyses

<br>

The Bayesian analyses were performed using the Stan programming
language [@stan]. This was accessed by the high level inferface
rstanarm [@rstanarm] package wrapper and the `stan_surv` function.
Analyses were performed with 2 different priors, the built-in default
non-informative normal prior (normal (0, 2.5) and an informative prior
based on a previous study of the risk of pacemakers implantation in a
population undergoing surgical aortic valve replacement (SAVR) [@RN5759].
All analyses were executed within the integrated development environment
of RStudio and the statistical ccode can be found on
[Github](https://github.com/brophyj/tavr_pace). <br>

## Results

<br>

### Verifying individual data extraction

<br>

```{r load 8 years data}
# load the complete digitalized KM datasets
load(here::here("output/data/both_ipd8.RData"))
```

```{r frequentist cox}
# Fit Cox
cox <- survival::coxph(survival::Surv(time, status) ~ 1 + treat,
                       data = both_ipd8)

tidy_cox = 
  broom::tidy(cox, conf.int = T, exponentiate = T) %>% 
  select(-1) %>% 
  round(2)

```

Quality assessment of our Kaplan--Meier-derived IPD data extraction was
performed analytically by calculating the overall hazard ration and 95%
CI and graphically by checking the derived Kaplan--Meier curves (Figure
1) with the previously published propensity matched KM curves (Original
Supplemental Figure 2). Not only is the data extraction judged to be
adequate graphically but also numerically with a calculated HR = `r tidy_cox$estimate`,
95% CI `r tidy_cox$conf.low` - `r tidy_cox$conf.high` which compares favorably with the published value (HR: 1.03; 95% CI: 0.88 - 1.22).

```{r fig1, fig.height= 5, fig.width=5.5, fig.align='center'}

fig1 <- survminer::ggsurvplot(
    fit = survival::survfit(survival::Surv(time, status) ~ 1 + treat,
                            data = both_ipd8), 
    censor = F,
    xlab = "Time (years)", 
    ylab = "Cumulative Survival",
    conf.int = FALSE,
    xlim = c(0,8),
    ylim = c(0, 1),
    color = "strata",
    palette = c("black", "#EA3324"),
    risk.table = TRUE,
    risk.table.col = "strata", # Risk table color by groups
    legend.labs = c("No pacemaker", "Pacemaker"),    # Change legend labels
    risk.table.height = 0.3,
    legend.title = " ") 

print(fig1, newpage = FALSE)

```

```{r diagnostics cox}

cox.zph <- survival::cox.zph(cox)  

# survminer::ggcoxzph(cox.zph)
# survminer::ggcoxdiagnostics(cox, type = "deviance", linear.predictions = FALSE)
```


<br>

The difference in survival probabilities with the 95% CI is plotted in
Figure 2. One of the concerns with the original analysis was the
possibility of time varying proportional hazards which is again
suggested in this Figure. However, statistical tests suggested the
proportional hazards assumption was not violated (p = `r round(cox.zph$table[1,3],2)`), although it
bears mentioning that the power to detect violations with this sample
size is limited [@Austin].\
<br>

```{r fig2 output, fig.width=5.5, fig.height=4, fig.align='center'}
f <- rms::npsurv(survival::Surv(time, status) ~ 1 + treat,
                            data = both_ipd8)

fig2 <- rms::survdiffplot(f,
                          order=2:1, # "Pacemaker" minus "No pacemaker"
                          time.inc=1,
                          conf.int = 0.95,
                          conf="shaded",
                          xlab = "Time (years)")

```

### Standard survival analysis to 4 years

```{r load 4 years data}
# load the 4-years digitalized KM datasets
load(here::here("output/data/both_ipd4.RData"))
```

```{r cox 4 years}

# Fit Cox for 4 year data
cox4 <- survival::coxph(survival::Surv(time, status) ~ 1 + treat,
                       data = both_ipd4)

tidy_cox4 = 
  broom::tidy(cox4, conf.int = T, exponentiate = T) %>% 
  select(-1) %>% 
  round(2)

#preferred method to plot KM extracted data for 4 year window

supp1 <- survminer::ggsurvplot(
    fit = survival::survfit(survival::Surv(time, status) ~ 1 + treat,
                            data = both_ipd4), 
    xlab = "Time (years", 
    ylab = "Overall survival probability",
    title = "Figure 3 Reconstructed PS matched\n KM curves (4 year follow-up)",
    conf.int = FALSE,
    xlim = c(0,8),
    ylim = c(0, 1),
    risk.table = TRUE,
    risk.table.col = "strata", # Risk table color by groups
    legend.labs = c("No pacemaker", "Pacemaker"),    # Change legend labels
    legend.title = " ") 



```

Even if the proportional hazards assumptions are not violated,
clinically it is indicated to investigate the risks over a more
restricted time window. In accordance also with the varying risks, we
elected a priori to concentrate on a 4 year time window. Using this time
frame, we extracted the individual data as described in Methods section
above. The frequentist Cox proportional hazards model analysis for this
more restricted data set results in a HR = `r tidy_cox4$estimate`, 95% CI `r tidy_cox4$conf.low` - `r tidy_cox4$conf.high`, p =
`r tidy_cox4$p.value`. While this remains statistically not significant, the point
estimate has clearly moved towards a survival benefit in the no
pacemaker group. Using this analysis to conclude that a pacemaker does
not influence 4 year mortality risks making a type II error (absence of
evidence is not evidence of absence). To further explore the data, we
next performed a bayesian survival analysis. <br>

### Bayesian surival analysis

```{r load bayesian models}

# Posteriors
load(here::here("output/fit/bayesian_model_vague.RData"))
load(here::here("output/fit/bayesian_model_informative.RData"))

```

```{r vague interval + probability}
vague_interval = 
  vague %>% 
  tidybayes::tidy_draws() %>% 
  ggdist::mean_qi(treatPacemaker) %>% 
  dplyr::select(1:3) %>% 
  exp() %>% 
  round(2)

vague_prob = 
  vague %>% 
  tidybayes::tidy_draws() %>% 
  summarise(prob = 100*round(mean(treatPacemaker > log(1)),2))


```

```{r informative interval + probability}
# Prior info
prior_informative = rstanarm::prior_summary(informative)


prior_mean = round(exp(prior_informative$priorEvent$location), 2)
prior_ci = 
  stringr::str_c(
    round(exp(prior_informative$priorEvent$location - 
      prior_informative$priorEvent$scale * 1.96),2),
    " - ",
    round(exp(prior_informative$priorEvent$location + 
      prior_informative$priorEvent$scale * 1.96), 2)
  )


informative_interval = 
  informative %>% 
  tidybayes::tidy_draws() %>% 
  ggdist::mean_qi(treatPacemaker) %>% 
  dplyr::select(1:3) %>% 
  exp() %>% 
  round(2)

informative_prob = 
  informative %>% 
  tidybayes::tidy_draws() %>% 
  summarise(prob = 100*round(mean(treatPacemaker > log(1)),2))

```

Bayesian approaches to survival analysis can provide a number of
benefits over the classical frequentist approach, including the ability
to make direct probability statements about parameters of interest (the
risk of pacemaker implantation), and to incorporate prior knowledge.
Using a vaguely non-informative prior the HR is `r vague_interval[[1]]`, 95% credible interval (CrI `r vague_interval[[2]]` - `r vague_interval[[3]]`). While the CrI
approximates the previously calculated CI, it can now used to formulate
direct probability statements. As shown in Figure 3, the absence of a
pacemaker is compatible with a `r vague_prob[[1]]`% probability of decreased mortality
compared to those receiving a pacemaker.
<br>

```{r fig3, fig.width=7, fig.height=8, fig.align='center'}
# Prior info
prior_vague = rstanarm::prior_summary(vague)
SWEDEHEART_mean = log(1.03)
SWEDEHEART_se = (log(1.22) - log(0.88))/3.92
  
p1 = 
  vague %>%
  tidybayes::tidy_draws() %>%
  ggplot(aes(x = treatPacemaker,
             fill_ramp = stat(x > log(1)))
         ) +
  # Only posterior with  ggdist::stat_halfeye()
  ggdist::stat_halfeye(fill = "skyblue", # distribution fill
                       # very important so all distributions are comparable
                       normalize = "none", 
                       .width = 0.95, # 95% CrI
                       point_interval = ggdist::mean_qi
                       ) +
  # To fill posterior distribution OR > 1 as gray
  ggdist::scale_fill_ramp_discrete(from = "gray85", range = c(0,1)) +
  
  # Prior 
  stat_function(fun = dnorm,
                args = c(mean = prior_vague$priorEvent$location,
                         sd = prior_vague$priorEvent$scale),
                alpha = 0.8) +
  # Original data 
  stat_function(fun = dnorm,
                args = c(mean = SWEDEHEART_mean,
                         sd = SWEDEHEART_se),
                alpha = 0.5,
                color = "firebrick") +
  
  # Prior
  annotate(geom = "curve",
           x = log(0.7), y = 1.4,
           xend = log(0.75), yend = 0.25, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(0.7), y = 1.7, label = "Vague Prior", hjust = "center") +
  
  
  # Original data
  annotate(geom = "curve",
           x = log(0.8), y = 3.8,
           xend = log(0.93), yend = 3, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(0.8), y = 4.1, label = "SWEDEHEART TAVR", hjust = "center") +
  
  # Posterior
  annotate(geom = "curve",
           x = log(1.28), y = 3.05,
           xend = log(1.2), yend = 2.3, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(1.5), y = 3.1, label = "Posterior Distribution", hjust = "center") +
  
  # Vertical dashed line
  geom_vline(xintercept = log(1), linetype = 2) +
  
  scale_y_continuous(limits = c(0, 6),
                     breaks = seq(0, 6, 2),
                     expand = c(0, 0.1)) +
  scale_x_continuous(breaks = log(seq(0.7, 1.6, 0.1)),
                     limits = log(c(0.65, 1.75)),
                     labels = seq(0.7, 1.6, 0.1)) +
  labs(x = "Hazard Ratio (log scale)",
       y = "Density") +
  ggdist::theme_ggdist() +
  theme(legend.position = 'none',
        plot.title.position = 'plot',
        plot.margin = margin(20, 20, 20, 20))

p2 = 
  informative %>%
  tidybayes::tidy_draws() %>%
  ggplot(aes(x = treatPacemaker,
             fill_ramp = stat(x > log(1)))
         ) +
  # Only posterior with  ggdist::stat_halfeye()
  ggdist::stat_halfeye(fill = "skyblue", # distribution fill
                       # very important so all distributions are comparable
                       normalize = "none", 
                       .width = 0.95, # 95% CrI
                       point_interval = ggdist::mean_qi
                       ) +
  # To fill posterior distribution OR > 1 as gray
  ggdist::scale_fill_ramp_discrete(from = "gray85", range = c(0,1)) +
  
  # Prior 
  stat_function(fun = dnorm,
                args = c(mean = prior_informative$priorEvent$location,
                         sd = prior_informative$priorEvent$scale),
                alpha = 0.5) +
  # Original data 
  stat_function(fun = dnorm,
                args = c(mean = SWEDEHEART_mean,
                         sd = SWEDEHEART_se),
                alpha = 0.5,
                color = "firebrick") +
  
  # Prior
  annotate(geom = "curve",
           x = log(1.45), y = 1.76,
           xend = log(1.35), yend = 1.1, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(1.65), y = 1.8, label = "Informative Prior", hjust = "center") +
  
  
  # Original data
  annotate(geom = "curve",
           x = log(0.8), y = 3.8,
           xend = log(0.93), yend = 3, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(0.8), y = 4.1, label = "SWEDEHEART TAVR", hjust = "center") +
  
  # Posterior
  annotate(geom = "curve",
           x = log(1.31), y = 5.1,
           xend = log(1.17), yend = 4.5, 
           curvature = .3, arrow = arrow(length = unit(1.5, "mm"))) +
  annotate(geom = "text",
           x = log(1.53), y = 5.1, label = "Posterior Distribution", hjust = "center") +
  
  # Vertical dashed line
  geom_vline(xintercept = log(1), linetype = 2) +
  
  scale_y_continuous(limits = c(0, 6),
                     breaks = seq(0, 6, 2),
                     expand = c(0, 0.1)) +
  scale_x_continuous(breaks = log(seq(0.7, 1.6, 0.1)),
                     limits = log(c(0.65, 1.75)),
                     labels = seq(0.7, 1.6, 0.1)) +
  labs(x = "Hazard Ratio (log scale)",
       y = "Density") +
  ggdist::theme_ggdist() +
  theme(legend.position = 'none',
        plot.title.position = 'plot',
        plot.margin = margin(20, 20, 20, 20))

p1 / p2 + plot_annotation(tag_levels = "A")
```

Previously research using the same Swedish databases have examined the
risk of a pacemaker in patients undergoing SAVR [@RN5759] and found an
increased risk (HR 1.14; 95% CI, 1.01 - 1.29). Given the
similarities in the populations, everyone with aortic stenosis
undergoing treatment in the same hospitals in the same treatment
windows, it seems reasonable to use this information to represent our
prior beliefs. With this informative prior the HR for the no pacemaker
group is `r prior_mean`, 95% credible interval (CrI `r prior_ci`). Given this
informative prior is consistent with the observed TAVR data, the slight
rightward shift and narrowing of the 95% CrI of the posterior
distribution compared to the posterior with a vaguely informative prior
is to be expected (Figure 3). Using this informative prior, it can
be appreciated that the probability of increased mortality following a
pacemaker post TAVR is `r informative_prob[[1]]`%.\
<br>


## Discussion

In this reanalysis of a recent publication from the SWEDEHEART
registry [@RN5759], we were able to reliably extract the individual
patient data concerning TAVR mortality as a function of receiving or not
a permanent cardiac pacemaker. As the original analysis used a 10 year
follow-up window and as the hazard rates varied over time, we analyzed
the risk associated with a cardiac pacemaker using a shorter 4 year
window. This has the advantages of being a period when the hazard ratios
appear constant as well as providing results in a more clinicially
pertinent risk window. Certainly one could argue that examining relative
risks at 10 years when mean entry age is 81 is of limited value, since
most patients will be deceased by this time, independently of the
presence or absence of a pacemaker following their TAVR. Our standard
survival analysis using 4 year mortality as the outcome revealed an
increased risk following pacemaker insertion (HR = `r tidy_cox4$estimate`, 95% CI `r tidy_cox4$conf.low` -
`r tidy_cox4$conf.high`) which not reach statistical significance (p = `r tidy_cox4$p.value`). However, the
goal of this re-analysis was not to evaluate statistical significance
but rather to estimate the probability of any increase in total
mortality experienced by the pacemaker group. The estimation of this
parameter requires a formal Bayesian survival analysis.\
<br>

The Bayesian analysis with a vaguely information prior revealed a `r vague_prob[[1]]`%
probability of increased mortality among TAVR patients requiring a
pacemaker group compared those not requiring same. The probability of
increased mortality is increased to `r informative_prob[[1]]`% probability when partial of
full prior knowledge about the risk of mortality with pacemakers in
aortic stenosis patients undergoing SAVR is integrated in the decision
calculus.\
<br>

The results from this Bayesian reanalysis lead to questions about the
original conclusion of "no difference in long-term survival between
patients who did and did not undergo permanent pacemaker implantation
after TAVR". By concentrating on parameter estimation rather than on
null hypothesis statistical testing and by incorporating relevant
background knowledge, this Bayesian analysis arguably leads to a more
insightful assessment of the risks of pacemakers following TAVR. Using
aggregate data from previous clinical trials, multiple publication have
demonstrated the additional advantages of Bayesian re-analyses. The
current publication suggests that similar benefits maybe observed when
this approach is applied to individual patient data in the context of an
observational research design.


`r pagebreak()` ## References
